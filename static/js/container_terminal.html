<!DOCTYPE html>
<html lang="en">
<head>
  <title>Tenxcloud Container Terminal</title>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="../style/container_terminal.css">
  <script src="term.js"></script>
  <script>
    function base64_encode(str) {
      if (window.btoa) // Internet Explorer 10 and above  
        return window.btoa(unescape(encodeURIComponent(str)));
      else {
        var Base64 = { _keyStr: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=", encode: function (e) { var t = ""; var n, r, i, s, o, u, a; var f = 0; e = Base64._utf8_encode(e); while (f < e.length) { n = e.charCodeAt(f++); r = e.charCodeAt(f++); i = e.charCodeAt(f++); s = n >> 2; o = (n & 3) << 4 | r >> 4; u = (r & 15) << 2 | i >> 6; a = i & 63; if (isNaN(r)) { u = a = 64 } else if (isNaN(i)) { a = 64 } t = t + this._keyStr.charAt(s) + this._keyStr.charAt(o) + this._keyStr.charAt(u) + this._keyStr.charAt(a) } return t }, decode: function (e) { var t = ""; var n, r, i; var s, o, u, a; var f = 0; e = e.replace(/[^A-Za-z0-9\+\/\=]/g, ""); while (f < e.length) { s = this._keyStr.indexOf(e.charAt(f++)); o = this._keyStr.indexOf(e.charAt(f++)); u = this._keyStr.indexOf(e.charAt(f++)); a = this._keyStr.indexOf(e.charAt(f++)); n = s << 2 | o >> 4; r = (o & 15) << 4 | u >> 2; i = (u & 3) << 6 | a; t = t + String.fromCharCode(n); if (u != 64) { t = t + String.fromCharCode(r) } if (a != 64) { t = t + String.fromCharCode(i) } } t = Base64._utf8_decode(t); return t }, _utf8_encode: function (e) { e = e.replace(/\r\n/g, "\n"); var t = ""; for (var n = 0; n < e.length; n++) { var r = e.charCodeAt(n); if (r < 128) { t += String.fromCharCode(r) } else if (r > 127 && r < 2048) { t += String.fromCharCode(r >> 6 | 192); t += String.fromCharCode(r & 63 | 128) } else { t += String.fromCharCode(r >> 12 | 224); t += String.fromCharCode(r >> 6 & 63 | 128); t += String.fromCharCode(r & 63 | 128) } } return t }, _utf8_decode: function (e) { var t = ""; var n = 0; var r = c1 = c2 = 0; while (n < e.length) { r = e.charCodeAt(n); if (r < 128) { t += String.fromCharCode(r); n++ } else if (r > 191 && r < 224) { c2 = e.charCodeAt(n + 1); t += String.fromCharCode((r & 31) << 6 | c2 & 63); n += 2 } else { c2 = e.charCodeAt(n + 1); c3 = e.charCodeAt(n + 2); t += String.fromCharCode((r & 15) << 12 | (c2 & 63) << 6 | c3 & 63); n += 3 } } return t } }
        // Encode the String  
        return Base64.encode(unescape(encodeURIComponent(str)));
      }
    }
  function base64_decode(str) {
    if (window.atob) // Internet Explorer 10 and above  
      return decodeURIComponent(escape(window.atob(str)));
    else {
      var Base64 = { _keyStr: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=", encode: function (e) { var t = ""; var n, r, i, s, o, u, a; var f = 0; e = Base64._utf8_encode(e); while (f < e.length) { n = e.charCodeAt(f++); r = e.charCodeAt(f++); i = e.charCodeAt(f++); s = n >> 2; o = (n & 3) << 4 | r >> 4; u = (r & 15) << 2 | i >> 6; a = i & 63; if (isNaN(r)) { u = a = 64 } else if (isNaN(i)) { a = 64 } t = t + this._keyStr.charAt(s) + this._keyStr.charAt(o) + this._keyStr.charAt(u) + this._keyStr.charAt(a) } return t }, decode: function (e) { var t = ""; var n, r, i; var s, o, u, a; var f = 0; e = e.replace(/[^A-Za-z0-9\+\/\=]/g, ""); while (f < e.length) { s = this._keyStr.indexOf(e.charAt(f++)); o = this._keyStr.indexOf(e.charAt(f++)); u = this._keyStr.indexOf(e.charAt(f++)); a = this._keyStr.indexOf(e.charAt(f++)); n = s << 2 | o >> 4; r = (o & 15) << 4 | u >> 2; i = (u & 3) << 6 | a; t = t + String.fromCharCode(n); if (u != 64) { t = t + String.fromCharCode(r) } if (a != 64) { t = t + String.fromCharCode(i) } } t = Base64._utf8_decode(t); return t }, _utf8_encode: function (e) { e = e.replace(/\r\n/g, "\n"); var t = ""; for (var n = 0; n < e.length; n++) { var r = e.charCodeAt(n); if (r < 128) { t += String.fromCharCode(r) } else if (r > 127 && r < 2048) { t += String.fromCharCode(r >> 6 | 192); t += String.fromCharCode(r & 63 | 128) } else { t += String.fromCharCode(r >> 12 | 224); t += String.fromCharCode(r >> 6 & 63 | 128); t += String.fromCharCode(r & 63 | 128) } } return t }, _utf8_decode: function (e) { var t = ""; var n = 0; var r = c1 = c2 = 0; while (n < e.length) { r = e.charCodeAt(n); if (r < 128) { t += String.fromCharCode(r); n++ } else if (r > 191 && r < 224) { c2 = e.charCodeAt(n + 1); t += String.fromCharCode((r & 31) << 6 | c2 & 63); n += 2 } else { c2 = e.charCodeAt(n + 1); c3 = e.charCodeAt(n + 2); t += String.fromCharCode((r & 15) << 12 | (c2 & 63) << 6 | c3 & 63); n += 3 } } return t } }
      // Encode the String  
      return decodeURIComponent(escape(Base64.decode(str)));
    }
  } 
  </script>
  <script>
    "use strict";
     var ws
     var term
    // Initialize everything when the window finishes loading
    window.addEventListener("load", function(event) {
        webSocketConnect()
        //Close websocket on time
        window.addEventListener('message', function(event) {
          if(!event.isTrusted) return
          if(event.data === 'close') {
            closeWebSocket(ws, term)
          }
          if(event.data === 'reshow') {
            webSocketConnect()
          }
        })
    });
    window.addEventListener("resize", function(e){
      var rowsNum = parseInt(e.target.innerHeight / 12) - 2;
      var colsNum = parseInt((e.target.innerWidth - 40) / 12) - 2;
      if(colsNum <= 5) {
        colsNum = 5;
      }
      term.resize(colsNum, rowsNum)
      term.element.focus();
    })
    function webSocketConnect() {
      var params = location.href.split('?')[1].split('&');
      var data = {}
      for(var ii = 0; ii < params.length; ii++) {
        var temp = params[ii].split('=')[0];
        data[temp] = params[ii].split('=')[1];
      }
//    params.map((param) => {
//      data[param.split('=')[0]] = param.split('=')[1];
//    });
      var host = window.location.host
     
      var wsUrl = 'ws://'+ host + '/api/v1/namespaces/' + data['namespace'] + '/pods/' + data['pod'] + '/exec'
      console.log("wsUrl: "+ wsUrl)

      function utf8_to_b64( str ) {
        return base64_encode(str)
      }
      function b64_to_utf8( str ) {
        return base64_decode(str) 
      }
      
      terminalConnect();
     
      // Create a new terminal connection to a container
      function terminalConnect() {
        var rowsNum = parseInt(window.innerHeight / 12) - 2;
        var colsNum = parseInt((window.innerWidth - 40) / 12) - 2;
        ws = new WebSocket(wsUrl, "base64.channel.k8s.io");
        ws.addEventListener("open", function(event) {
          term = new Terminal({
            cols: colsNum,
            rows: rowsNum,
            screenKeys: true
          });

          term.open(document.body.terminal);
          term.write("*******************************************************\r\n");  
          term.write("||    _____                   _                 _    ||\r\n");  
          term.write("||   |_   _|__ _ __ __  _____| | ___  _   _  __| |   ||\r\n"); 
          term.write("||     | |/ _ \\ '_ \\\\ \\/ / __| |/ _ \\| | | |/ _` |   ||\r\n"); 
          term.write("||     | |  __/ | | |>  < (__| | (_) | |_| | (_| |   ||\r\n"); 
          term.write("||     |_|\\___|_| |_/_/\\_\\___|_|\\___/ \\__,_|\\__,_|   ||\r\n"); 
          term.write("||                                                   ||\r\n"); 
          term.write("***********************************Tenxcloud Enterprise\r\n\r\n"); 
                                                                                                                

          //term.write('\x1b[31mWelcome to Tenxcloud Web Terminal!\x1b[m\r\n\r\n');


          term.cursorHidden = false;
          term.showCursor();
          term.refresh(term.x, term.y);
          term.element.focus();

          term.on('data', function(data) {
              if (ws && ws.readyState === 1)
                  ws.send("0" + utf8_to_b64(data));
          });
        });

        // Display messages received from the server
        ws.addEventListener("message", function(event) {
          var data = event.data.slice(1);
          term.write(b64_to_utf8(data));
        });

        // Display any errors that occur
        ws.addEventListener("error", function(event) {
          try {
            term.write(b64_to_utf8("Error: " + JSON.stringify(event)));
          }catch(err) {
          }finally {
           closeWebSocket(ws, term)
         }
        });
      }
    }

    function closeWebSocket(ws, term) {
      if (ws) {
         ws.onopen = ws.onmessage = ws.onerror = ws.onclose = null;
         if (ws.readyState < 2) // CLOSING
            ws.close();
            ws = null;
          }
         if(term) {
            term.destroy()
            term = null
         }
    }
    
    function focusTerminal() {
      term.showCursor();
      term.refresh(term.x, term.y);
      term.element.focus();
    }
    
    function closeTerminal() {
      closeWebSocket(ws, term);
    }
  </script>
</head>
<body>
  <div id="terminal"></div>
</body>
</html>
